import { View, Text, StyleSheet, StatusBar, Platform, ScrollView, ActivityIndicator } from 'react-native'
import React, { useState, useEffect } from 'react'
import { SafeAreaProvider, useSafeAreaInsets } from 'react-native-safe-area-context'
import { BlurView } from 'expo-blur'
import { scale } from '../../utils/styling'
import { auth, db } from '../../firebaseConfig';
import { onAuthStateChanged } from 'firebase/auth';
import { doc, getDoc, collection, onSnapshot, query, where, orderBy, limit } from 'firebase/firestore';
import { Pressable } from 'react-native';
import { Image, Dimensions } from 'react-native';
import { router } from 'expo-router';

// This function is copied from home.js to ensure consistent image optimization.
const getOptimizedImageUrl = (url, width) => {
  if (!url) return false;
  const parts = url.split('/upload/');
  if (parts.length === 2) {
    return `${parts[0]}/upload/w_${width},q_auto:best/${parts[1]}`;
  }
  return url;
};

const favourite = () => {
  const insets = useSafeAreaInsets();
  const [favoriteRooms, setFavoriteRooms] = useState([]);
  const [loading, setLoading] = useState(true);

  useEffect(() => {
    // Listen for authentication state changes to get the current user's ID
    const unsubscribeAuth = onAuthStateChanged(auth, (user) => {
      if (user) {
        // Create a reference to the user's 'favorites' subcollection
        const userFavoritesRef = collection(db, 'users', user.uid, 'favorites');
        
        // Set up a real-time listener for changes in the favorites collection, ordered by timestamp
        const unsubscribeFavorites = onSnapshot(query(userFavoritesRef, orderBy('timestamp', 'desc')), async (querySnapshot) => {
          const favoritePromises = querySnapshot.docs.map(async (favDoc) => {
            const favoriteData = favDoc.data();
            const roomRef = favoriteData.roomRef; // This is the DocumentReference
            
            if (roomRef) {
              try {
                const roomSnap = await getDoc(roomRef);
                if (roomSnap.exists()) {
                  // Attach the timestamp for sorting later if needed, though the query already handles it
                  return { 
                    id: roomSnap.id, 
                    ...roomSnap.data(),
                    favoriteTimestamp: favoriteData.timestamp
                  };
                }
              } catch (error) {
                console.error("Error fetching favorited room: ", error);
              }
            }
            return null; // Return null for invalid or non-existent references
          });

          // Wait for all promises to resolve and filter out non-existent rooms
          const rooms = (await Promise.all(favoritePromises)).filter(Boolean);
          setFavoriteRooms(rooms);
          setLoading(false);
        }, (error) => {
          console.error("Error fetching favorites: ", error);
          setLoading(false);
        });

        // Clean up the favorites listener when the component unmounts
        return () => unsubscribeFavorites();
      } else {
        // No user logged in, clear favorites and stop loading
        setFavoriteRooms([]);
        setLoading(false);
      }
    });

    // Clean up the auth listener when the component unmounts
    return () => unsubscribeAuth();
  }, []);

  return (
    <SafeAreaProvider>
      <StatusBar barStyle="dark" />

      <View 
        style={{ 
          height: insets.top, 
          backgroundColor: '#63c5ec5d', 
          position: 'absolute', 
          top: 0, left: 0, right: 0 
        }} 
      />
            
      <View style={[styles.container, { marginTop: insets.top }]}></View>
      
      <View style={styles.titleView}>
        <BlurView 
          intensity={Platform.OS === 'ios'? 9 : 36 }
          tint="light"
          experimentalBlurMethod="dimezisBlurView"
          style={styles.blurOverlay}
        />
        <Text style={styles.savedTitle}>Saved Rooms</Text>
      </View>

      <ScrollView contentContainerStyle={styles.roomsContainer}>
        {loading ? (
          // Show a loading indicator while data is being fetched
          <ActivityIndicator size="large" color="#00315e" style={styles.loader} />
        ) : favoriteRooms.length > 0 ? (
          // Render the list of favorite rooms
          <View style={styles.otherRoomsContainer}>
            {favoriteRooms.map(room => (
              <Pressable
                key={room.id}
                style={styles.otherRoomCard}
                onPress={() => router.push({
                  pathname: './../room/details',
                  params: { roomId: room.id, userId: room.userId }
                })}
              >
                <Image
                  source={{ uri: getOptimizedImageUrl(room.imageUrls && room.imageUrls.length > 0 ? room.imageUrls[0] : null, 600) }}
                  style={styles.otherRoomImage}
                />
                <View style={styles.otherRoomInfo}>
                  <Text style={styles.otherRoomTitle} numberOfLines={1}>{room.title}</Text>
                  <Text style={styles.otherRoomPrice}>Rs: {room.price}/month</Text>
                  <Text style={styles.otherLocation} numberOfLines={1}>Location: {room.place}</Text>
                  <Text style={styles.otherRoomType}>{room.roomType}</Text>
                </View>
              </Pressable>
            ))}
          </View>
        ) : (
          // Show a message if there are no favorite rooms
          <Text style={styles.noDataText}>You haven't favorited any rooms yet.</Text>
        )}
      </ScrollView>
    </SafeAreaProvider>
  )
}

export default favourite;

const styles = StyleSheet.create({ 
  // blur view
  blurOverlay: {
    position: 'absolute',
    height: 42,
    left: 0,
    right: 0,
    zIndex: 2,
  },

  // headings
  titleView: {
    height: 42,
    backgroundColor: Platform.OS === 'ios' ? '#63c5ec5d' : '#63c5ec75',
  },
  savedTitle: {
    fontSize: Platform.OS === 'ios' ? scale(24) : scale(18),
    color: '#00315e',
    fontWeight: 'bold', 
    paddingTop: 4,
    paddingBottom: 12,
    textAlign: 'center',
    zIndex: 5,
  },

  // Rooms container styles
  roomsContainer: {
    marginTop: scale(-3),
    paddingTop: scale(10),
    marginBottom: Platform.OS === 'ios' ? scale(40) : scale(46),
    minHeight: scale(650),
  },
  loader: {
    marginTop: scale(52),
  },
  noDataText: {
    textAlign: 'center',
    marginTop: 20,
    fontSize: 14,
    color: '#888',
  },
  // other rooms card styles
  otherRoomsContainer: {
    flexDirection: 'row',
    flexWrap: 'wrap',
    justifyContent: 'space-between',
    paddingHorizontal: scale(5),
    marginLeft: scale(5),
    marginRight: scale(5),
    marginVertical: scale(8),
  },
  otherRoomCard: {
    backgroundColor: '#fafafaff',
    borderRadius: 10,
    padding: 10,
    marginBottom: 10,
    width: '48%', // For two columns
    shadowColor: '#000',
    shadowOffset: { width: 2, height: 3 },
    shadowOpacity: 0.2,
    shadowRadius: 4,
    elevation: 3,
  },
  otherRoomImage: {
    width: '100%',
    height: Platform.OS === 'ios' ? scale(110) : scale(100),
    borderRadius: 8,
    marginBottom: 5,
  },
  otherRoomInfo: {
    flex: 1,
    justifyContent: 'center',
  },
  otherRoomTitle: {
    fontSize: Platform.OS === 'ios' ? scale(16) : scale(14),
    fontWeight: 'bold',
    color: '#00315e',
    marginBottom: 2,
  },
  otherRoomPrice: {
    fontSize: Platform.OS === 'ios' ? scale(14) : scale(12),
    fontWeight: 'bold',
    color: '#00315e',
    marginBottom: 2,
  },
  otherLocation: {
    fontSize: Platform.OS === 'ios' ? scale(15.4) : scale(12.6),
    color: '#00315eda',
    fontWeight: '600',
    marginBottom: 2,
  },
  otherRoomType: {
    fontSize: Platform.OS === 'ios' ? scale(15) : scale(12),
    color: '#00315eda',
    fontWeight: '600',
  },
});





import { View, Text, StyleSheet, StatusBar, Platform, ScrollView, ActivityIndicator } from 'react-native'
import React, { useEffect, useState } from 'react'
import { SafeAreaProvider, useSafeAreaInsets } from 'react-native-safe-area-context'
import { BlurView } from 'expo-blur'
import { scale } from '../../utils/styling'
import { auth, db } from '../../firebaseConfig';
import { onAuthStateChanged } from 'firebase/auth';
import { doc, getDoc, collection, onSnapshot, query, where, orderBy, limit, QuerySnapshot } from 'firebase/firestore';
import { Pressable } from 'react-native';
import { Image, Dimensions } from 'react-native';
import { router } from 'expo-router';


const getOptimizedImageUrl = (url, width) => {
  if (!url) return false;
  const parts = url.split('/upload/');
  if (parts.length === 2) {
    return `${parts[0]}/upload/w_${width},q_auto:best/${parts[1]}`;
  }
  return url;
};

const favourite = () => {
  const insets = useSafeAreaInsets();
  const [favouriteRooms, setFavouriteRooms] = useState([]);
  const [loading, setLoading] = useState(true);

  useEffect(() => {
    const unsubscribeAuth = onAuthStateChanged (auth, (user) =>{
        if(user){
        const userFavouriteRef = collection(db, 'users', user.uid, 'favorites');

        const unsubscribeFavourites = onSnapshot(query(userFavouriteRef, orderBy('timestamp', 'desc')), async (QuerySnapshot) => {
          const favouritePromises = QuerySnapshot.docs.map(async (favDoc) => {
            const favouriteData = favDoc.data();
            const roomRef = favouriteData.roomRef;

            if(roomRef){
              try{
                const roomSnap = await getDoc(roomRef);
                if (roomSnap.exists()) {
                  return { 
                    id: roomSnap.id, 
                    ...roomSnap.data(),
                    favouriteTimestamp: favouriteData.timestamp
                  };
                }
              }
              catch (error){
                console.error("Error fetching favourited room: ", error);
              }
            }
            return null;

          });

          const rooms = (await Promise.all(favouritePromises)).filter(Boolean);
          setFavouriteRooms(rooms);
          setTimeout(() =>{
            setLoading(false);
          }, Platform.OS === 'ios' ? 100 : 200);

        }, error =>{
          console.error("Error fetching favourites: ", error);
          setLoading(false);
        });
        return () => unsubscribeFavourites();
      } else{
        setFavouriteRooms([]);
        setLoading(false);
      }
    } );
    return () => unsubscribeAuth();
  }, []);



  return (
    <SafeAreaProvider>
      <StatusBar barStyle="dark"/>

      <View 
        style={{ 
          height: insets.top, 
          backgroundColor: '#63c5ec5d', 
          // backgroundColor: '#cae6f3ff',
          position: 'absolute', 
          top: 0, left: 0, right: 0 
        }} 
      />
            
      <View style={[styles.container, {marginTop: insets.top}]}></View>


      

      <View style={styles.titleView}>
        <BlurView 
          intensity={Platform.OS === 'ios'? 9 : 36 }
          tint="light"
          experimentalBlurMethod="dimezisBlurView"
          style={styles.blurOverlay}
        />
        <Text style={styles.savedTitle}>Saved Rooms</Text>

      </View>

      <ScrollView contentContainerStyle={styles.roomsContainer}>

        {loading ? (
          // Show a loading indicator while data is being fetched
          <ActivityIndicator size="large" color="#00315e" style={styles.loader} />
        ) : favouriteRooms.length > 0 ? (
          // Render the list of favourite rooms
          <View style={styles.otherRoomsContainer}>
            {favouriteRooms.map(room => (
              <Pressable
                key={room.id}
                style={styles.otherRoomCard}
                onPress={() => router.push({
                  pathname: './../room/details',
                  params: { roomId: room.id, userId: room.userId }
                })}
              >
                <Image
                  source={{ uri: getOptimizedImageUrl(room.imageUrls && room.imageUrls.length > 0 ? room.imageUrls[0] : null, 600) }}
                  style={styles.otherRoomImage}
                />
                <View style={styles.otherRoomInfo}>
                  <Text style={styles.otherRoomTitle} numberOfLines={1}>{room.title}</Text>
                  <Text style={styles.otherRoomPrice}>Rs: {room.price}/month</Text>
                  <Text style={styles.otherLocation} numberOfLines={1}>Location: {room.place}</Text>
                  <Text style={styles.otherRoomType}>{room.roomType}</Text>
                </View>
              </Pressable>
            ))}
          </View>
        ) : (
          // Show a message if there are no favourite rooms
          <Text style={styles.noDataText}>You haven't favourited any rooms yet.</Text>
        )}

      </ScrollView>
    </SafeAreaProvider>
  )
}

export default favourite;

const styles = StyleSheet.create({ 

  // blur view
  blurOverlay: {
    position: 'absolute',
    height:42,
    left: 0,
    right: 0,
    zIndex: 4,
  },

  // headings
  titleView: {
    height: 42,
    backgroundColor:  Platform.OS === 'ios'? '#63c5ec5d' : '#63c5ec75',

  },
  savedTitle: {
    fontSize: Platform.OS === 'ios' ? scale(24) : scale(18),
    color: '#00315e',
    fontWeight: 'bold',   
    paddingTop: 4,
    paddingBottom: 12,
    textAlign: 'center',
    zIndex: 5,

  },


   roomsContainer: {
    marginTop: -38,
    // paddingTop: scale(42),
    // paddingTop: scale(10),
    marginBottom: Platform.OS === 'ios' ? scale(40) : scale(46),
    minHeight: scale(650),
    zIndex:1,
  },
  loader: {
    marginTop: scale(52),
  },
  noDataText: {
    textAlign: 'center',
    marginTop: 20,
    fontSize: 14,
    color: '#888',
  },
  // other rooms card styles
  otherRoomsContainer: {
    flexDirection: 'row',
    flexWrap: 'wrap',
    justifyContent: 'space-between',
    paddingHorizontal: scale(5),
    marginLeft: scale(5),
    marginRight: scale(5),
    marginVertical: scale(8),
  },
  otherRoomCard: {
    backgroundColor: '#fafafaff',
    borderRadius: 10,
    padding: 10,
    marginBottom: 10,
    width: '48%', // For two columns
    shadowColor: '#000',
    shadowOffset: { width: 2, height: 3 },
    shadowOpacity: 0.2,
    shadowRadius: 4,
    elevation: 3,
  },
  otherRoomImage: {
    width: '100%',
    height: Platform.OS === 'ios' ? scale(110) : scale(100),
    borderRadius: 8,
    marginBottom: 5,
  },
  otherRoomInfo: {
    flex: 1,
    justifyContent: 'center',
  },
  otherRoomTitle: {
    fontSize: Platform.OS === 'ios' ? scale(16) : scale(14),
    fontWeight: 'bold',
    color: '#00315e',
    marginBottom: 2,
  },
  otherRoomPrice: {
    fontSize: Platform.OS === 'ios' ? scale(14) : scale(12),
    fontWeight: 'bold',
    color: '#00315e',
    marginBottom: 2,
  },
  otherLocation: {
    fontSize: Platform.OS === 'ios' ? scale(15.4) : scale(12.6),
    color: '#00315eda',
    fontWeight: '600',
    marginBottom: 2,
  },
  otherRoomType: {
    fontSize: Platform.OS === 'ios' ? scale(15) : scale(12),
    color: '#00315eda',
    fontWeight: '600',
  },



});